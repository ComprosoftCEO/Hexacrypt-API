#include <PrimeMap.h>
#include <PrimeMap-Constants.h>

#include <Rand64.h>
#include <Hash8.h>

#include <string.h>

typedef struct {
    uint32_t lookup[256];
    pRand64 rand;
} PrimeMap_Obj, *pPrimeMap_Obj;

static const uint32_t ALL_PRIMES[256] = {
    PRIME32_0,  PRIME32_1,  PRIME32_2,  PRIME32_3,  PRIME32_4,  PRIME32_5,  PRIME32_6,  PRIME32_7,
    PRIME32_8,  PRIME32_9,  PRIME32_10, PRIME32_11, PRIME32_12, PRIME32_13, PRIME32_14, PRIME32_15,
    PRIME32_16, PRIME32_17, PRIME32_18, PRIME32_19, PRIME32_20, PRIME32_21, PRIME32_22, PRIME32_23,
    PRIME32_24, PRIME32_25, PRIME32_26, PRIME32_27, PRIME32_28, PRIME32_29, PRIME32_30, PRIME32_31,
    PRIME32_32, PRIME32_33, PRIME32_34, PRIME32_35, PRIME32_36, PRIME32_37, PRIME32_38, PRIME32_39,
    PRIME32_40, PRIME32_41, PRIME32_42, PRIME32_43, PRIME32_44, PRIME32_45, PRIME32_46, PRIME32_47,
    PRIME32_48, PRIME32_49, PRIME32_50, PRIME32_51, PRIME32_52, PRIME32_53, PRIME32_54, PRIME32_55,
    PRIME32_56, PRIME32_57, PRIME32_58, PRIME32_59, PRIME32_60, PRIME32_61, PRIME32_62, PRIME32_63,
    PRIME32_64, PRIME32_65, PRIME32_66, PRIME32_67, PRIME32_68, PRIME32_69, PRIME32_70, PRIME32_71,
    PRIME32_72, PRIME32_73, PRIME32_74, PRIME32_75, PRIME32_76, PRIME32_77, PRIME32_78, PRIME32_79,
    PRIME32_80, PRIME32_81, PRIME32_82, PRIME32_83, PRIME32_84, PRIME32_85, PRIME32_86, PRIME32_87,
    PRIME32_88, PRIME32_89, PRIME32_90, PRIME32_91, PRIME32_92, PRIME32_93, PRIME32_94, PRIME32_95,
    PRIME32_96, PRIME32_97, PRIME32_98, PRIME32_99, PRIME32_100,PRIME32_101,PRIME32_102,PRIME32_103,
    PRIME32_104,PRIME32_105,PRIME32_106,PRIME32_107,PRIME32_108,PRIME32_109,PRIME32_110,PRIME32_111,
    PRIME32_112,PRIME32_113,PRIME32_114,PRIME32_115,PRIME32_116,PRIME32_117,PRIME32_118,PRIME32_119,
    PRIME32_120,PRIME32_121,PRIME32_122,PRIME32_123,PRIME32_124,PRIME32_125,PRIME32_126,PRIME32_127,
    PRIME32_128,PRIME32_129,PRIME32_130,PRIME32_131,PRIME32_132,PRIME32_133,PRIME32_134,PRIME32_135,
    PRIME32_136,PRIME32_137,PRIME32_138,PRIME32_139,PRIME32_140,PRIME32_141,PRIME32_142,PRIME32_143,
    PRIME32_144,PRIME32_145,PRIME32_146,PRIME32_147,PRIME32_148,PRIME32_149,PRIME32_150,PRIME32_151,
    PRIME32_152,PRIME32_153,PRIME32_154,PRIME32_155,PRIME32_156,PRIME32_157,PRIME32_158,PRIME32_159,
    PRIME32_160,PRIME32_161,PRIME32_162,PRIME32_163,PRIME32_164,PRIME32_165,PRIME32_166,PRIME32_167,
    PRIME32_168,PRIME32_169,PRIME32_170,PRIME32_171,PRIME32_172,PRIME32_173,PRIME32_174,PRIME32_175,
    PRIME32_176,PRIME32_177,PRIME32_178,PRIME32_179,PRIME32_180,PRIME32_181,PRIME32_182,PRIME32_183,
    PRIME32_184,PRIME32_185,PRIME32_186,PRIME32_187,PRIME32_188,PRIME32_189,PRIME32_190,PRIME32_191,
    PRIME32_192,PRIME32_193,PRIME32_194,PRIME32_195,PRIME32_196,PRIME32_197,PRIME32_198,PRIME32_199,
    PRIME32_200,PRIME32_201,PRIME32_202,PRIME32_203,PRIME32_204,PRIME32_205,PRIME32_206,PRIME32_207,
    PRIME32_208,PRIME32_209,PRIME32_210,PRIME32_211,PRIME32_212,PRIME32_213,PRIME32_214,PRIME32_215,
    PRIME32_216,PRIME32_217,PRIME32_218,PRIME32_219,PRIME32_220,PRIME32_221,PRIME32_222,PRIME32_223,
    PRIME32_224,PRIME32_225,PRIME32_226,PRIME32_227,PRIME32_228,PRIME32_229,PRIME32_230,PRIME32_231,
    PRIME32_232,PRIME32_233,PRIME32_234,PRIME32_235,PRIME32_236,PRIME32_237,PRIME32_238,PRIME32_239,
    PRIME32_240,PRIME32_241,PRIME32_242,PRIME32_243,PRIME32_244,PRIME32_245,PRIME32_246,PRIME32_247,
    PRIME32_248,PRIME32_249,PRIME32_250,PRIME32_251,PRIME32_252,PRIME32_253,PRIME32_254,PRIME32_255
};



pPrimeMap New_Prime_Map(uint64_t seed) {

    pPrimeMap_Obj pmap = (pPrimeMap_Obj) malloc(sizeof(PrimeMap_Obj));
    pmap->rand = New_Rand64_Seed(seed);

    Reseed_Prime_Map(pmap,seed);

    return (pPrimeMap) pmap;
}


void Reseed_Prime_Map(pPrimeMap pm, uint64_t seed) {
    pPrimeMap_Obj pmap = (pPrimeMap_Obj) pm;

    Rand64_Reseed(pmap->rand,seed);
    memcpy(pmap->lookup,ALL_PRIMES,sizeof(ALL_PRIMES));
    Shuffle_Prime_Map(pmap);
}



void Free_Prime_Map(pPrimeMap pm) {

    pPrimeMap_Obj pmap = (pPrimeMap_Obj) pm;
    Free_Rand64(pmap->rand);
    free(pm);
}



void Shuffle_Prime_Map(pPrimeMap pm) {

    pPrimeMap_Obj pmap = (pPrimeMap_Obj) pm;
    uint32_t* arr = pmap->lookup;

    int i;
    for (i = 0; i < 256; ++i) {
        int index = Rand64_Next(pmap->rand) % (256 - i);

        uint32_t temp = arr[0];
        arr[0] = arr[index];
        arr[index] = temp;

        ++arr;
    }
}



uint32_t Prime_Map(pPrimeMap pm, uint32_t input) {

    pPrimeMap_Obj pmap = (pPrimeMap_Obj) pm;
    uint32_t result = input;

    int i;
    for (i = 0; i < sizeof(input); ++i) {
        uint8_t byte = input & 0xFF;
        input >>= 8;

        result ^= ROTATE_LEFT(pmap->lookup[byte],i*8);
    }

    return result;
}
